<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CellsFocusVisibleMixin test</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>

<body>

  <test-fixture id="default">
    <template>
      <focus-visible-button tabindex="0"></focus-visible-button>
    </template>
  </test-fixture>

  <script type="module">
    import { CellsFocusVisibleMixin, LitElement, html } from './test.js';
    suite('CellsFocusVisibleMixin', () => {

      let el;
      let elementShadowRoot;
      const HAS_NEW_FOCUSIN = new FocusEvent('focusin');
      const HAS_NEW_FOCUSOUT = new FocusEvent('focusout');
      const HAS_NEW_MOUSE = new MouseEvent('mousedown');
      const HAS_NEW_KEY = new KeyboardEvent('keydown');

      suiteSetup(() => {
        class focusVisibleButton extends CellsFocusVisibleMixin(LitElement) {
          static get is() {
            return 'focus-visible-button';
          }
          render() {
            return html`
            <style>
              :host {
                display: inline-block;
                position: relative;
                cursor:pointer;

              }
              button {
                font:inherit;
                border:none;
                background-color:#1973B8;
                outline:none;
                border-radius:1px;
                color: #fff;
                padding: 0.25em 1.25em;
              }
              :host(:not([focus-visible])) button:focus{
                background-color:#1464A5
              }
              :host([focus-visible]) button:focus{
                outline: 2px solid #043263;
              }
            </style>
            <button>Focus</button>
          `;
          }
        }
        customElements.define(focusVisibleButton.is, focusVisibleButton);

      });


      setup(async () => {
        el = fixture('default');
        elementShadowRoot = el.shadowRoot;
        el.focusVisible = false;
        await el.updateComplete;
      });

      suite('Set or Remove focus-visible attribute', () => {
        test('Keydown event add focus-visible attribute', async () => {
          window.dispatchEvent(HAS_NEW_KEY);
          el.dispatchEvent(HAS_NEW_FOCUSIN);
          await Promise.resolve();
          assert.equal(el.hasAttribute('focus-visible'), true);
        });

        test('Mousedown event remove focus-visible attribute', async () => {
          window.dispatchEvent(HAS_NEW_MOUSE);
          el.dispatchEvent(HAS_NEW_FOCUSIN);
          await Promise.resolve();
          assert.equal(el.hasAttribute('focus-visible'), false);
        });
      });

      suite('Keydown and Mousedown Events', () => {
        test('Keydown event set focusVisible to true', async () => {
          window.dispatchEvent(HAS_NEW_KEY);
          el.dispatchEvent(HAS_NEW_FOCUSIN);
          await Promise.resolve();
          assert.equal(el.focusVisible, true);
        });

        test('Mousedown event set focusVisible to false', async () => {
          window.dispatchEvent(HAS_NEW_MOUSE);
          el.dispatchEvent(HAS_NEW_FOCUSIN);
          await Promise.resolve();
          assert.equal(el.focusVisible, false);
        });

        test('Focusout event set focusVisible to false', async () => {
          el.dispatchEvent(HAS_NEW_FOCUSOUT);
          await Promise.resolve();
          assert.equal(el.focusVisible, false);
        });

        test('Changes between keydown and mousedown, fire a focus-visible-changed event', (done) => {
          window.dispatchEvent(HAS_NEW_KEY);
          Promise.resolve().then(() => {
            window.dispatchEvent(HAS_NEW_MOUSE);
          });

          document.addEventListener('focus-visible-changed', (event) => {
            assert.equal(event.detail.focusVisible, false);
            done();
          });
        });
      });
    });
  </script>

</body>

</html>
