<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>cells-demo-helper test</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/@webcomponents/shadycss/scoping-shim.min.js"></script>
  <script src="../node_modules/@webcomponents/shadycss/apply-shim.min.js"></script>
  <script src="../node_modules/@webcomponents/shadycss/custom-style-interface.min.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>

<body>
  <test-fixture id="default">
    <template>
      <cells-demo-helper>
        <cells-demo-case heading="Case 1"><template>Demo case 0</template></cells-demo-case>
        <cells-demo-case heading="Case 2"><template>Demo case 1</template></cells-demo-case>
        <cells-demo-case heading="Case 3"><template>Demo case 2</template></cells-demo-case>
      </cells-demo-helper>
    </template>
  </test-fixture>

  <test-fixture id="events">
    <template>
      <cells-demo-helper events='["event1"]'>
        <cells-demo-case heading="Case 1"><template></template></cells-demo-case>
        <cells-demo-case heading="Case 2"><template>Demo case 2</template></cells-demo-case>
        <cells-demo-case heading="Case 3"><template>Demo case 3</template></cells-demo-case>
      </cells-demo-helper>
    </template>
  </test-fixture>

  <script type="module">
    import './test.js';

    console.log('first')
    suite('<cells-demo-helper> basic', () => {
      let el;

      setup(() => {
        el = fixture('default');
        el._noHead = true;
      });
      suite('Demo cases', () => {
        test('Loads the first case by default', (done) => {
          el.addEventListener('iframe-loaded', () => {
            const iframe = el.shadowRoot.querySelector('iframe');
            const iframeDoc = iframe.contentDocument;
            const iframeHtml = iframeDoc.body.innerHTML;
            assert.equal(iframeHtml.trim(), 'Demo case 0');
            done();
          });
        });

        test('Demo selector shows the heading of each cells-demo-case in light DOM', (done) => {
          let childrens = el.querySelectorAll('cells-demo-case');
          el.addEventListener('iframe-loaded', () => {
            [...childrens,].forEach((child, index) => {
              assert.equal(el._cases[index].name, child.heading);
            });
            done();
          });
        });

        test('Changing the case in demo selector changes iframe content', (done) => {
          el.selected = 2;
          el.addEventListener('iframe-loaded', () => {
            const iframe = el.shadowRoot.querySelector('iframe');
            const iframeDoc = iframe.contentDocument;
            const iframeHtml = iframeDoc.body.innerHTML;
            assert.equal(iframeHtml.trim(), 'Demo case 2');
            done();
          });
        });
      });

      suite('Cache Scripts', () => {
        let el;
        setup(async() => {
          el = fixture('default');
          el._noHead = false;
          await el.updateComplete;
        });

        test('Scripts are cached',  () => {
          assert.isNotNull(el._cacheScriptsHeadIframe , '_cacheScriptsHeadIframe has been defined');
        });
      });

      suite('Code', () => {
        setup(() => {
          el = fixture('default');
          el._noHead = true;
          return el.updateComplete;
        });

        test('Generates the code for the selected case', (done) => {
          async function eventCallback(e) {
            e.target.removeEventListener(e.type, eventCallback);
            await el.updateComplete;
            const code = el.shadowRoot.querySelector('#editor');
            assert.equal(code.content, 'Demo case 0');
            done();
          };
          el.addEventListener('iframe-loaded', eventCallback);
        });

        test('Changing the editor code updates the current demo case', async () => {
          el._editorValue = '';
          await el.updateComplete;

          el._editorValue = 'Demo case 0 changed :-)';
          await el.updateComplete;
          el.addEventListener('iframe-loaded', () => {
            const iframe = el.shadowRoot.querySelector('iframe');
            const iframeDoc = iframe.contentDocument;
            const iframeHtml = iframeDoc.body.innerHTML;
            assert.equal(iframeHtml.trim(), 'Demo case 0 changed :-)');

          });
        });

        test('clicking on copy button copies the code into clipboard', async () => {
          await el.updateComplete;
          const execCommandStub = sinon.stub(document, 'execCommand');
          el.shadowRoot.querySelector('#copyButton').click();
          await el.updateComplete;
          assert.equal(el.shadowRoot.querySelector('#copyButton').textContent, 'Copied!', 'text button changes to "Copied!"');
          assert.equal(execCommandStub.getCall(0).args[0], 'copy', 'execCommand is called with copy as param');
          document.execCommand.restore();
        });

        test('copy button text is reset after 1 second', async () => {
          await el.updateComplete;
          const timeoutStub = sinon.useFakeTimers();
          el.shadowRoot.querySelector('#copyButton').click();
          timeoutStub.tick(1000);
          assert.equal(el.shadowRoot.querySelector('#copyButton').textContent, 'Copy');
          timeoutStub.restore();
        });
      });
      suite('Tabs', () => {
        let tabs;
        let codeSection;

        test('Preview tab is selected by default', async () => {
          await el.updateComplete;
          tabs = el.shadowRoot.querySelector('.tabs');
          assert.equal(tabs.selected, 0);
          assert.equal(el._tabs[el._selectedTab], 'Preview');
        });

        test('Code is not visible by default', async () => {
          await el.updateComplete;
          codeSection = el.shadowRoot.querySelector('.overlay');
          assert.isFalse(codeSection.classList.contains('visible'));
        });

        test('Click on Code tab shows code', async () => {
          await el.updateComplete;
          tabs = el.shadowRoot.querySelector('.tabs');
          codeSection = el.shadowRoot.querySelector('.overlay');
          tabs.selected = 1;
          await el.updateComplete;
          await el.updateComplete;
          assert.isTrue(codeSection.classList.contains('visible'));
        });

        test('Click on Code tab disables :focus on iframe and selectors', (done) => {
          async function eventCallback(e) {
            e.target.removeEventListener(e.type, eventCallback);
            await el.updateComplete;
            tabs = el.shadowRoot.querySelector('.tabs');
            tabs.selected = 1;
            await el.updateComplete;
            await el.updateComplete;
            await el.updateComplete;
            const iframe = el.shadowRoot.querySelector('iframe');
            assert.equal(iframe.getAttribute('tabindex'), -1, 'iframe is not focusable');
            const dropdowns = el.shadowRoot.querySelectorAll('.dropdown');
            for (const [index, dropdown,] of dropdowns.entries()) {
              assert.equal(dropdown.getAttribute('tabindex'), -1, `selector ${index} is not focusable`);
            }
            done();
          };
          el.addEventListener('iframe-loaded', eventCallback);
        });
      });

      suite('<cells-demo-helper> events', () => {
        let el;

        setup(() => {
          el = fixture('events');
          el._noHead = true;
        });

        test('firing event inside iframe reaches event toaster outside iframe', (done) => {
          async function eventCallback(e) {
            e.target.removeEventListener(e.type, eventCallback);
            await el.updateComplete;
            const spy = sinon.spy();
            setTimeout(async () => {
              const toast = el.shadowRoot.querySelector('#eventToaster');
              const iframe = el.shadowRoot.querySelector('iframe');
              const iframeDoc = iframe.contentDocument;
              iframeDoc.dispatchEvent(new CustomEvent('WebComponentsReady'));
              await el.updateComplete;
              const event = new CustomEvent('event1', {
                bubbles: true,
                composed: true,
              });
              toast.addEventListener('event1', spy);
              iframeDoc.dispatchEvent(event);
              await el.updateComplete;
              assert.isTrue(spy.called);
              done();
            }, 100);
          };
          el.addEventListener('iframe-loaded', eventCallback);
        });
      });
    });
  </script>
</body>

</html>
