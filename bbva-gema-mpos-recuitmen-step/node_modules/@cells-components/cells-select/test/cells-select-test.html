<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

  <title>cells-select test</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>

<body>
  <button id="focusHelper"></button>
  <test-fixture id="default">
    <template>
      <cells-select label="Default">
        <cells-option value="madrid" name="opt1" id="mad">Madrid</cells-option>
        <cells-option value="bilbao" name="opt2" id="bil">Bilbao</cells-option>
        <cells-option value="ponferrada" name="opt3" id="pon">Ponferrada</cells-option>
        <cells-option value="barcelona" name="opt4" id="bar">Barcelona</cells-option>
        <cells-option value="logroño" name="opt5" id="log">Logroño</cells-option>
      </cells-select>
    </template>
  </test-fixture>

  <test-fixture id="array">
    <template>
      <cells-select label="Default">
      </cells-select>
    </template>
  </test-fixture>

  <test-fixture id="autofocus">
    <template>
      <cells-select label="Default" autofocus>
        <cells-option value="madrid">Madrid</cells-option>
        <cells-option value="bilbao">Bilbao</cells-option>
      </cells-select>
    </template>
  </test-fixture>

  <script type="module">
    import { chaiDomDiff, axeReport, keyDownOn } from './test.js';
    chai.use(chaiDomDiff);

    suite('<cells-select>', () => {
      let el;
      let elementShadowRoot;

      suite('default', () => {
        setup(async () => {
          el = fixture('default');
          elementShadowRoot = el.shadowRoot;
          await el.updateComplete;
        });

        test('a11y', function() {
          return axeReport(el);
        });

        test('SHADOW DOM - Structure test', () => {
          const shadowDom = `
            <span id="label" class="label" aria-hidden="true">Default</span>
            <button id="button" class="button" aria-haspopup="listbox" aria-labelledby="label button" aria-expanded="false" aria-invalid="false" ></button>
            <div class="options-layer ">
              <div id="list" class="list" role="listbox" aria-labelledby="label" aria-readonly="false" aria-required="false">
                <slot></slot>
              </div>
            </div>
            <span class="slot-select" aria-hidden="true" tabindex="-1">
              <slot name="_select"></slot>
            </span>
          `;
          expect(el).shadowDom.to.equal(shadowDom);
        });

        test('LIGHT DOM - Structure test', () => {
          const selectId = el.querySelector('select').getAttribute('id');
          const lightDom = `
            <cells-option value="madrid" name="opt1" id="mad" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Madrid</cells-option>
            <cells-option value="bilbao" name="opt2" id="bil" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Bilbao</cells-option>
            <cells-option value="ponferrada" name="opt3" id="pon" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Ponferrada</cells-option>
            <cells-option value="barcelona" name="opt4" id="bar" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Barcelona</cells-option>
            <cells-option value="logroño" name="opt5" id="log" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Logroño</cells-option>
            <select slot="_select" tabindex="-1" aria-hidden="true" id="${selectId}" name="">
              <option value=""></option>
            </select>
          `;
          expect(el).lightDom.to.equal(lightDom);
        });

        test('select without autofocus does not receive focus', () => {
          assert.notEqual(document.activeElement, el);
        });

        test('setting matching value selects option', async () => {
          el.value = 'ponferrada';
          assert.equal(el.selectedIndex, 2);
        });

        test('setting matching value before initial render selects option', async () => {
          el = fixture('default');
          el.value = 'ponferrada';
          await el.updateComplete;
          assert.equal(el.selectedIndex, 2);
        });

        test('setting same value does not update selected', async () => {
          el.value = 'ponferrada';
          assert.equal(el.selectedIndex, 2);
          el.value = 'ponferrada';
          assert.equal(el.selectedIndex, 2);
        });

        test('setting non-existing value clears selected option', async () => {
          el.value = 'ponferrada';
          assert.equal(el.selectedIndex, 2);
          el.value = 'nonexisting';
          assert.equal(el.selectedIndex, -1);
        });

        test('setting selectedIndex selects option', async () => {
          el.selectedIndex = 2;
          assert.equal(el.value, 'ponferrada');
        });

        test('setting selectedIndex before first render selects option', async () => {
          el = fixture('default');
          el.selectedIndex = 2;
          await el.updateComplete;
          assert.equal(el.value, 'ponferrada');
        });

        test('setting same selectedIndex does not update selected', async () => {
          el.selectedIndex = 2;
          assert.equal(el.value, 'ponferrada');
          el.selectedIndex = 2;
          assert.equal(el.value, 'ponferrada');
        });

        test('setting non-existing selectedIndex unselects options', async () => {
          el.selectedIndex = 999;
          assert.equal(el.value, '');
        });

        test('item method returns option with specified index', () => {
          const option = el.querySelectorAll('cells-option')[1];
          assert.equal(el.item(1), option);
        });

        test('namedItem method returns option with specified name', () => {
          const option = el.querySelectorAll('cells-option')[1];
          assert.equal(el.namedItem('opt2'), option);
        });

        test('namedItem method returns option with specified id', () => {
          const option = el.querySelectorAll('cells-option')[1];
          assert.equal(el.namedItem('bil'), option);
        });

        test('click on button opens select', async () => {
          const button = elementShadowRoot.querySelector('#button');
          const optionsLayer = elementShadowRoot.querySelector('.options-layer');
          assert.isFalse(optionsLayer.classList.contains('opened'));
          button.dispatchEvent(new MouseEvent('click'));
          await el.updateComplete;
          assert.isTrue(optionsLayer.classList.contains('opened'));
        });

        test('click on readonly button does not open select', async () => {
          el.readonly = true;
          const button = elementShadowRoot.querySelector('#button');
          const optionsLayer = elementShadowRoot.querySelector('.options-layer');
          assert.isFalse(optionsLayer.classList.contains('opened'));
          button.dispatchEvent(new MouseEvent('click'));
          await el.updateComplete;
          assert.isFalse(optionsLayer.classList.contains('opened'));
        });

        test('click on select with no selected option focuses first option', async () => {
          const button = elementShadowRoot.querySelector('#button');
          const firstOption = el.querySelectorAll('cells-option')[0];
          assert.isFalse(firstOption.focused);
          button.dispatchEvent(new MouseEvent('click'));
          await el.updateComplete;
          assert.isTrue(firstOption.focused);
        });

        test('click on select with selected option focuses selected option', async () => {
          el.selectedIndex = 2;
          const button = elementShadowRoot.querySelector('#button');
          const selectedOption = el.querySelectorAll('cells-option')[2];
          assert.isFalse(selectedOption.focused);
          button.dispatchEvent(new MouseEvent('click'));
          await el.updateComplete;
          assert.isTrue(selectedOption.focused);
        });

        test('click on option selects item and closes select', async () => {
          el.opened = true;
          await el.updateComplete;
          assert.equal(el.selectedIndex, -1);
          const option = el.querySelectorAll('cells-option')[2];
          option.dispatchEvent(new MouseEvent('click', {
            bubbles: true
          }));
          await el.updateComplete;
          assert.equal(el.selectedIndex, 2);
          assert.isFalse(el.opened);
        });

        suite('keys', () => {
          test('pressing printable character on closed select selects by name', async () => {
            assert.equal(el.selectedIndex, -1);
            keyDownOn(el, 66, '', 'b');
            await el.updateComplete;
            assert.equal(el.selectedIndex, 1);
          });

          test('pressing printable character on opened select focuses by name', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
            keyDownOn(el, 66, '', 'b');
            await el.updateComplete;
            assert.isTrue(options[1].focused);
          });

          test('escape key closes select', async () => {
            el.opened = true;
            await el.updateComplete;
            keyDownOn(el, 27, '', 'Escape');
            await el.updateComplete;
            assert.isFalse(el.opened);
          });

          test('enter key selects item and closes select', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            options[1].focused = true;
            await el.updateComplete;
            assert.equal(el.selectedIndex, -1);
            keyDownOn(el, 13, '', 'Enter');
            await el.updateComplete;
            assert.equal(el.selectedIndex, 1);
            assert.isFalse(el.opened);
          });

          test('enter key selects item and closes select', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            options[1].focused = true;
            await el.updateComplete;
            assert.equal(el.selectedIndex, -1);
            keyDownOn(el, 32, '', ' ');
            await el.updateComplete;
            assert.equal(el.selectedIndex, 1);
            assert.isFalse(el.opened);
          });

          test('arrow down focuses next item', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
            keyDownOn(el, 40, '', 'ArrowDown');
            await el.updateComplete;
            assert.isTrue(options[1].focused);
          });

          test('arrow up focuses previous item', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            options[1].focused = true;
            await el.updateComplete;
            keyDownOn(el, 38, '', 'ArrowUp');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
          });

          test('pagedown focuses last item', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
            keyDownOn(el, 34, '', 'PageDown');
            await el.updateComplete;
            assert.isTrue(options[4].focused);
          });

          test('pagedown focuses last item', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
            keyDownOn(el, 35, '', 'End');
            await el.updateComplete;
            assert.isTrue(options[4].focused);
          });

          test('pageup focuses last item', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            options[4].focused = true;
            await el.updateComplete;
            keyDownOn(el, 33, '', 'PageUp');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
          });

          test('pageup focuses last item', async () => {
            el.opened = true;
            const options = el.querySelectorAll('cells-option');
            await el.updateComplete;
            options[4].focused = true;
            await el.updateComplete;
            keyDownOn(el, 36, '', 'Home');
            await el.updateComplete;
            assert.isTrue(options[0].focused);
          });
        });
      });

      suite('array', () => {
        setup(async () => {
          el = fixture('array');
          elementShadowRoot = el.shadowRoot;
          el.items = [{
            text: 'Madrid',
            value: 'madrid'
          }, {
            text: 'Bilbao',
            value: 'bilbao'
          }, {
            text: 'Ponferrada',
            value: 'ponferrada',
            selected: true
          }, {
            text: 'Barcelona',
            value: 'barcelona'
          }, {
            text: 'Logroño',
            value: 'logroño'
          }];
          await el.updateComplete;
        });

        test('a11y', function() {
          return axeReport(el);
        });

        test('SHADOW DOM - Structure test', () => {
          const shadowDom = `
            <span id="label" class="label" aria-hidden="true">Default</span>
            <button id="button" class="button" aria-haspopup="listbox" aria-labelledby="label button" aria-expanded="false" aria-invalid="false" >Ponferrada</button>
            <div class="options-layer ">
              <div id="list" class="list" role="listbox" aria-labelledby="label" aria-readonly="false" aria-required="false">
                <slot></slot>
                <cells-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Madrid</cells-option>
                <cells-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Bilbao</cells-option>
                <cells-option selected="" role="option" aria-disabled="false" aria-selected="true" tabindex="-1">Ponferrada</cells-option>
                <cells-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Barcelona</cells-option>
                <cells-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Logroño</cells-option>
              </div>
            </div>
            <span class="slot-select" aria-hidden="true" tabindex="-1">
              <slot name="_select"></slot>
            </span>
          `;
          expect(el).shadowDom.to.equal(shadowDom);
        });

        test('LIGHT DOM - Structure test', () => {
          const selectId = el.querySelector('select').getAttribute('id');
          const lightDom = `
            <select slot="_select" tabindex="-1" aria-hidden="true" id="${selectId}" name="">
              <option value="ponferrada">ponferrada</option>
            </select>
          `;
          expect(el).lightDom.to.equal(lightDom);
        });
      });

      suite('autofocus', () => {
        setup(async () => {
          el = fixture('autofocus');
          elementShadowRoot = el.shadowRoot;
          await el.updateComplete;
        });

        test('select with autofocus receives focus', () => {
          assert.equal(document.activeElement, el);
        });
      });

    });
  </script>
</body>

</html>
