/* eslint-disable no-console */
/**
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
*/
let CustomStyleInterface;

if (window.ShadyCSS && window.ShadyCSS.CustomStyleInterface) {
  CustomStyleInterface = window.ShadyCSS.CustomStyleInterface;
} else {
  CustomStyleInterface = undefined;
  console.warn(
    'CustomStyleInterface shim not detected. Be sure to add ShadyCSS CustomStyleInterface to your app when running on browsers without native Shadow DOM!',
  );
}

/**
 * Custom element for defining styles in the main document that can take
 * advantage of [shady DOM](https://github.com/webcomponents/shadycss) shims
 * for style encapsulation and custom properties.
 *
 * - Document styles defined in a `<bbva-core-custom-style>` are shimmed to ensure they
 *   do not leak into local DOM when running on browsers without native
 *   Shadow DOM.
 * - Custom properties can be defined in a `<bbva-core-custom-style>`. Use the `html` selector
 *   to define custom properties that apply to all custom elements.
 *
 * To use:
 *
 * - Place a `<bbva-core-custom-style>` element in the main document, wrapping an inline `<style>` tag that
 *   contains the CSS rules you want to shim.
 *
 * <bbva-core-custom-style>
 *   <style>
 *     html {
 *       --custom-color: blue;
 *       --custom-mixin: {
 *         font-weight: bold;
 *         color: red;
 *       };
 *     }
 *   </style>
 * </bbva-core-custom-style>
 * ```
 *
 * @customElement bbva-core-custom-style
 * @polymer
 * @LitElement
 */
export class BbvaCoreCustomStyle extends HTMLElement {
  constructor() {
    super();
    if (CustomStyleInterface) {
      this._style = null;
      CustomStyleInterface.addCustomStyle(this);
    }
  }

  /**
   * Returns the light-DOM `<style>` child this element wraps.
   *
   * @export
   * @return {HTMLStyleElement} This element's light-DOM `<style>`
   */
  getStyle() {
    if (this._style) {
      return this._style;
    }
    const style = /** @type {HTMLStyleElement} */ (this.querySelector('style'));
    if (!style) {
      return null;
    }
    this._style = style;
    /*
    HTML Imports styling the main document are deprecated in Chrome
    https://crbug.com/523952

    If this element is not in the main document, then it must be in an HTML Import document.
    In that case, move the custom style to the main document.

    The ordering of `<bbva-core-custom-style>` should stay the same as when loaded by HTML Imports, but there may be odd
    cases of ordering w.r.t the main document styles.
    */
    if (this.ownerDocument !== window.document) {
      window.document.head.appendChild(this);
    }
    return this._style;
  }
}

if (!customElements.get('bbva-core-custom-style')) {
  customElements.define('bbva-core-custom-style', BbvaCoreCustomStyle);
}
