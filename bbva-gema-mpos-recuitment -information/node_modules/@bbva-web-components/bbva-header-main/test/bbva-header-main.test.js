import { html, fixture, assert, fixtureCleanup } from '@open-wc/testing';
import sinon from 'sinon';

import '../bbva-header-main.js';

const IMAGE_1PIXEL =
  'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';

suite('bbva-header-main', () => {
  let el;

  teardown(() => fixtureCleanup());

  setup(async () => {
    el = await fixture(
      html`
        <bbva-header-main text="default"></bbva-header-main>
      `,
    );
    await el.updateComplete;
  });

  test('it shows the correct text', async () => {
    const expectedText = 'hello World';
    el.text = expectedText;
    await el.updateComplete;
    const textShowed = el.shadowRoot.querySelector('#text').textContent;

    assert.equal(textShowed, expectedText);
  });

  [
    {
      selector: '#btn-left1',
      event: 'header-main-icon-left1-click',
    },
    {
      selector: '#btn-left2',
      event: 'header-main-icon-left2-click',
    },
    {
      selector: '#btn-right1',
      event: 'header-main-icon-right1-click',
    },
    {
      selector: '#btn-right2',
      event: 'header-main-icon-right2-click',
    },
  ].forEach(button => {
    test(`it sends ${button.event} event`, () => {
      const btn = el.shadowRoot.querySelector(button.selector);
      const spy = sinon.spy();

      el.addEventListener(button.event, spy);
      btn.click();
      assert.ok(spy.calledOnce);
    });
  });

  [
    {
      selector: '#btn-left1',
    },
    {
      selector: '#btn-left2',
    },
    {
      selector: '#btn-right1',
    },
    {
      selector: '#btn-right2',
    },
  ].forEach(button => {
    test(`it doesn't shows ${button.selector} when icons have no value`, () => {
      const btn = el.shadowRoot.querySelector(button.selector);
      assert.ok(btn.hidden);
    });
  });

  test('it headding has "full-padding" class when it has icon left or right', async () => {
    el.iconLeft2 = 'foo';
    await el.updateComplete;
    const headding = el.shadowRoot.querySelector('#headding');

    assert.ok(headding.classList.contains('full-padding'));
  });

  test('it headding has "image" class when it has an image', async () => {
    const pixelImage = IMAGE_1PIXEL;
    el.image = pixelImage;
    await el.updateComplete;
    const headding = el.shadowRoot.querySelector('#headding');

    assert.ok(headding.classList.contains('image'));
  });

  test('it shows the image correctly when it has an image', async () => {
    const pixelImage = IMAGE_1PIXEL;
    el.image = pixelImage;
    await el.updateComplete;
    const image = el.shadowRoot.querySelector('#image');

    assert.notOk(image.hidden, 'image not hidden');
    assert.ok(image.src.includes('data:image/gif;base64'), 'correct image source');
  });

  test('a11y', () => assert.isAccessible(el));

  test('SHADOW DOM - Structure test', () => {
    assert.shadowDom.equalSnapshot(el, { ignoreAttributes: ['id'] });
  });

  test('LIGHT DOM - Structure test', () => {
    assert.lightDom.equalSnapshot(el);
  });
});
