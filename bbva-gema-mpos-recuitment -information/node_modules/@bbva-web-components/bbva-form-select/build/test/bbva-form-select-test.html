<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>bbva-form-select test</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>

<body>

  <test-fixture id="default">
    <template>
      <bbva-form-select label="Default">
        <bbva-form-option value="option0"></bbva-form-option>
        <bbva-form-option value="option1">Option 1</bbva-form-option>
        <bbva-form-option value="option2" selected>Option 2</bbva-form-option>
        <bbva-form-option value="option3">Option 3</bbva-form-option>
      </bbva-form-select>
    </template>
  </test-fixture>

  <test-fixture id="options">
    <template>
      <bbva-form-select label="Default" invalid error-message="Error" info-message="Info" show-value required>
        <bbva-form-option value="option0"></bbva-form-option>
        <bbva-form-option value="option1">Option 1</bbva-form-option>
        <bbva-form-option value="option2" selected>Option 2<span slot="clip">Clip</span></bbva-form-option>
        <bbva-form-option value="option3">Option 3</bbva-form-option>
      </bbva-form-select>
    </template>
  </test-fixture>

  <test-fixture id="array">
      <template>
        <bbva-form-select label="Default"></bbva-form-select>
      </template>
    </test-fixture>

  <script type="module">
    import { chaiDomDiff, axeReport } from './test.js';
    chai.use(chaiDomDiff);

    suite('bbva-form-select', () => {
      let el;
      let elementShadowRoot;

      suite('default', () => {

        setup(async () => {
          el = fixture('default');
          elementShadowRoot = el.shadowRoot;
          await el.updateComplete;
        });
        test('a11y', function () {
          return axeReport(el);
        });

        test('SHADOW DOM - Structure test', () => {
          const result = `
          <button id="button" class="button" aria-haspopup="listbox" aria-labelledby="label button" aria-expanded="false" aria-invalid="false">
            <span class="button-content">
              <span class="button-text">
                <span id="label" class="label" aria-hidden="true">Default</span>
                <span class="content">
                  <span class="content-text">
                    Option 2
                  </span>
                </span>
              </span>
              <span class="button-icon" aria-hidden="true">
                <cells-icon style="--cells-icon-size:1.5rem;"></cells-icon>
              </span>
            </span>
          </button>

          <div class="options-layer ">
            <div class="options-overlay"></div>
            <div class="options-gradient">
              <div class="options-wrapper">
                <div id="list" class="list" role="listbox" aria-labelledby="label" aria-readonly="false" aria-required="false">
                  <slot></slot>
                </div>
              </div>
            </div>
          </div>

          <span class="slot-select" aria-hidden="true" tabindex="-1">
            <slot name="_select"></slot>
          </span>
        `;
          expect(el).shadowDom.to.equal(result);
        });

        test('LIGHT DOM - Structure test', () => {
          const id = el.querySelector('select').getAttribute('id');
          const result = `
        <bbva-form-option value="option0" role="option" aria-disabled="false" aria-selected="false" tabindex="-1"></bbva-form-option>
          <bbva-form-option value="option1" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Option 1</bbva-form-option>
          <bbva-form-option value="option2" selected="" role="option" aria-disabled="false" aria-selected="true" tabindex="-1">Option 2</bbva-form-option>
          <bbva-form-option value="option3" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Option 3</bbva-form-option>
          <select slot="_select" tabindex="-1" aria-hidden="true" id="${id}" name="">
            <option value="option2">option2</option>
          </select>
        `;
          expect(el).lightDom.to.equal(result);
        });

        test('setting option with no text removes filled attribute', async () => {
          assert.isTrue(el.hasAttribute('filled'));

          el.selectedIndex = 0;
          await el.updateComplete;

          assert.isFalse(el.hasAttribute('filled'));
        });

        test('opening select adds opened class', async () => {
          const layer = elementShadowRoot.querySelector('.options-layer');
          assert.isFalse(layer.classList.contains('opened'));

          el.opened = true;
          await el.updateComplete;

          assert.isTrue(layer.classList.contains('opened'));
        });

        test('opening select updated select icon', async () => {
          const icon = elementShadowRoot.querySelector('.button-icon cells-icon');
          assert.equal(icon.icon, el.openIcon);

          el.opened = true;
          await el.updateComplete;

          assert.equal(icon.icon, el.closeIcon);
        });
      });

      suite('options', () => {
        setup(async () => {
          el = fixture('options');
          elementShadowRoot = el.shadowRoot;
          await el.updateComplete;
        });

        test('a11y', function () {
          return axeReport(el);
        });

        test('SHADOW DOM - Structure test', () => {
          const result = `
            <button id="button" class="button" aria-haspopup="listbox" aria-labelledby="label button" aria-expanded="false" aria-invalid="true">
              <span class="button-content">
                <span class="button-clip" aria-hidden="true">
                  <span slot="clip">Clip</span>
                </span>
                <span class="button-text">
                  <span id="label" class="label" aria-hidden="true">Default *</span>
                  <span class="content">
                    <span class="content-text">
                      Option 2Clip
                    </span>
                    <span class="content-value">
                      option2
                    </span>
                  </span>
                </span>
                <span class="button-icon" aria-hidden="true">
                  <cells-icon style="--cells-icon-size:1.5rem;"></cells-icon>
                </span>
              </span>
            </button>

            <div class="options-layer ">
              <div class="options-overlay"></div>
              <div class="options-gradient">
                <div class="options-wrapper">
                  <div id="list" class="list" role="listbox" aria-labelledby="label" aria-readonly="false" aria-required="true">
                    <slot></slot>
                  </div>
                </div>
              </div>
            </div>

            <span class="slot-select" aria-hidden="true" tabindex="-1">
              <slot name="_select"></slot>
            </span>
            <div class="message error">
              <cells-icon class="message-icon" aria-hidden="true" style="--cells-icon-size:1rem;"></cells-icon>
              <span>Error</span>
            </div>
            <div class="message info">
              <cells-icon class="message-icon" aria-hidden="true" style="--cells-icon-size:1rem;"></cells-icon>
              <span>Info</span>
            </div>
          `;
          expect(el).shadowDom.to.equal(result);
        });

        test('LIGHT DOM - Structure test', () => {
          const id = el.querySelector('select').getAttribute('id');
          const result = `
            <bbva-form-option value="option0" role="option" aria-disabled="false" aria-selected="false" tabindex="-1"></bbva-form-option>
            <bbva-form-option value="option1" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Option 1</bbva-form-option>
            <bbva-form-option value="option2" selected="" role="option" aria-disabled="false" aria-selected="true" tabindex="-1">Option 2<span slot="clip">Clip</span></bbva-form-option>
            <bbva-form-option value="option3" role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Option 3</bbva-form-option>
            <select slot="_select" tabindex="-1" aria-hidden="true" required id="${id}" name="">
              <option value="option2">option2</option>
            </select>
          `;
          expect(el).lightDom.to.equal(result);
        });

      });

      suite('array', () => {

        setup(async () => {
          el = fixture('array');
          elementShadowRoot = el.shadowRoot;
          el.items = [{
            text: '',
            value: 'option0'
          }, {
            text: 'Option 1',
            value: 'option1'
          }, {
            text: 'Option 2',
            value: 'option2',
            selected: true
          }, {
            text: 'Option 3',
            value: 'option3'
          }]
          await el.updateComplete;
        });

        test('a11y', function () {
          return axeReport(el);
        });

        test('SHADOW DOM - Structure test', () => {
          const result = `
            <button id="button" class="button" aria-haspopup="listbox" aria-labelledby="label button" aria-expanded="false" aria-invalid="false">
              <span class="button-content">
                <span class="button-text">
                  <span id="label" class="label" aria-hidden="true">Default</span>
                  <span class="content">
                    <span class="content-text">
                      Option 2
                    </span>
                  </span>
                </span>
                <span class="button-icon" aria-hidden="true">
                  <cells-icon style="--cells-icon-size:1.5rem;"></cells-icon>
                </span>
              </span>
            </button>

            <div class="options-layer ">
              <div class="options-overlay"></div>
              <div class="options-gradient">
                <div class="options-wrapper">
                  <div id="list" class="list" role="listbox" aria-labelledby="label" aria-readonly="false" aria-required="false">
                    <slot></slot>
                    <bbva-form-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1"></bbva-form-option>
                    <bbva-form-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Option 1</bbva-form-option>
                    <bbva-form-option selected="" role="option" aria-disabled="false" aria-selected="true" tabindex="-1">Option 2</bbva-form-option>
                    <bbva-form-option role="option" aria-disabled="false" aria-selected="false" tabindex="-1">Option 3</bbva-form-option>
                  </div>
                </div>
              </div>
            </div>

            <span class="slot-select" aria-hidden="true" tabindex="-1">
              <slot name="_select"></slot>
            </span>
          `;
          expect(el).shadowDom.to.equal(result);
        });

        test('LIGHT DOM - Structure test', () => {
          const id = el.querySelector('select').getAttribute('id');
          const result = `
            <select slot="_select" tabindex="-1" aria-hidden="true" id="${id}" name="">
              <option value="option2">option2</option>
            </select>
          `;
          expect(el).lightDom.to.equal(result);
        });

      });

    });
  </script>

</body>

</html>
