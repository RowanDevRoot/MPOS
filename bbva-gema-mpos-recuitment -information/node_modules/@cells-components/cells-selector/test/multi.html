<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<html>
<head>

  <title>cells-selector-multi</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/wct-browser-legacy/browser.js"></script>

  <style>
    .cells-selected {
      background: #ccc;
    }
  </style>

</head>
<body>

  <test-fixture id="test">
    <template>
      <cells-selector multi>
        <div>Item 0</div>
        <div>Item 1</div>
        <div>Item 2</div>
        <div>Item 3</div>
        <div>Item 4</div>
      </cells-selector>
    </template>
  </test-fixture>

  <test-fixture id="valueById">
    <template>
      <cells-selector multi attr-for-selected="id">
        <div id="item0">Item 0</div>
        <div id="item1">Item 1</div>
        <div id="item2">Item 2</div>
        <div id="item3">Item 3</div>
        <div id="item4">Item 4</div>
      </cells-selector>
    </template>
  </test-fixture>

  <script type="module">
    import '@polymer/iron-test-helpers/iron-test-helpers.js';
    import '../cells-selector.js';
    suite('multi', () => {
      let s;

      setup(async () => {
        s = fixture('test');
        return await s.updateComplete;
      });

      test('honors the multi attribute', () => {
        assert.isTrue(s.multi);
      });

      test('has sane defaults', () => {
        assert.deepEqual(s.selectedValues, []);
        assert.equal(s.selectedClass, 'cells-selected');
        assert.equal(s.items.length, 5);
      });

      test('set multi-selection via selected property', async () => {
        s.selectedValues = [0, 2];
        await s.updateComplete;
        assert.isTrue(s.children[0].classList.contains('cells-selected'));
        assert.isTrue(s.children[2].classList.contains('cells-selected'));
        assert.equal(s.selectedItems.length, 2);
        assert.equal(s.selectedItems[0], s.children[0]);
        assert.equal(s.selectedItems[1], s.children[2]);
      });

      test('set multi-selection via click', async () => {
        MockInteractions.click(s.children[0]);
        MockInteractions.click(s.children[2]);
        await s.updateComplete;
        assert.isTrue(s.children[0].classList.contains('cells-selected'));
        assert.isTrue(s.children[2].classList.contains('cells-selected'));
        assert.equal(s.selectedItems.length, 2);
        assert.equal(s.selectedItems[0], s.children[0]);
        assert.equal(s.selectedItems[1], s.children[2]);
      });

      test('fire cells-select/deselect events when selectedValues changes', async () => {
        // setup listener for cells-select/deselect events
        var items = [s.children[0], s.children[1], s.children[2]],
            selectEventCounters = [0, 0, 0], deselectEventCounters = [0, 0, 0];

        s.addEventListener('cells-select', (e) => {
          selectEventCounters[items.indexOf(e.detail.item)]++;
        });
        s.addEventListener('cells-deselect', (e) => {
          deselectEventCounters[items.indexOf(e.detail.item)]++;
        });

        // programatically select values 0 and 1 (both fire select)
        s.selectedValues = [0, 1];
        await s.updateComplete;

        // programatically select values 1 and 2 (2 fires select, 0 fires
        // deselect)
        s.selectedValues = [1, 2];
        await s.updateComplete;

        // programatically deselect all values (1 and 2 fire deselect)
        s.selectedValues = [];
        await s.updateComplete;

        // check events
        assert.equal(selectEventCounters[0], 1);
        assert.equal(deselectEventCounters[0], 1);
        assert.equal(selectEventCounters[1], 1);
        assert.equal(deselectEventCounters[1], 1);
        assert.equal(selectEventCounters[2], 1);
        assert.equal(deselectEventCounters[2], 1);
      });

      test('fire cells-select/deselect events when selectedValues is modified', async () => {
        // setup listener for cells-select/deselect events
        var items = [s.children[0], s.children[1], s.children[2]],
            selectEventCounters = [0, 0, 0], deselectEventCounters = [0, 0, 0];

        s.addEventListener('cells-select', (e) => {
          selectEventCounters[items.indexOf(e.detail.item)]++;
        });
        s.addEventListener('cells-deselect', (e) => {
          deselectEventCounters[items.indexOf(e.detail.item)]++;
        });

        s.selectedValues = [];
        await s.updateComplete;

        // programatically select value 0
        s.selectedValues = [0, 1];
        await s.updateComplete;

        // programatically deselect value 0
        s.selectedValues = [1];
        await s.updateComplete;

        // programatically select value 2
        s.selectedValues = [1, 2];
        await s.updateComplete;

        // programatically deselect value 1
        s.selectedValues = [2];
        await s.updateComplete;

        assert.equal(selectEventCounters[0], 1);
        assert.equal(deselectEventCounters[0], 1);
        assert.equal(selectEventCounters[1], 1);
        assert.equal(deselectEventCounters[1], 1);
        assert.equal(selectEventCounters[2], 1);
        assert.equal(deselectEventCounters[2], 0);
      });

      test('fire cells-select/deselect events when toggling items', async () => {
        // setup listener for cells-select/deselect events
        var items = [s.children[0], s.children[1], s.children[2]],
            selectEventCounters = [0, 0, 0], deselectEventCounters = [0, 0, 0];

        s.addEventListener('cells-select', (e) => {
          selectEventCounters[items.indexOf(e.detail.item)]++;
        });
        s.addEventListener('cells-deselect', (e) => {
          deselectEventCounters[items.indexOf(e.detail.item)]++;
        });

        // click to select items 0 and 1 (both fire select)
        MockInteractions.click(items[0]);
        await s.updateComplete;
        MockInteractions.click(items[1]);
        await s.updateComplete;

        // programatically select values 1 and 2 (2 fires select, 0 fires deselect)
        s.selectedValues = [1, 2];
        await s.updateComplete;

        // click to deselect items 1 and 2 (both fire deselect)
        MockInteractions.click(items[1]);

        MockInteractions.click(items[2]);
        await s.updateComplete;

        // check events
        assert.equal(selectEventCounters[0], 1);
        assert.equal(deselectEventCounters[0], 1);
        assert.equal(selectEventCounters[1], 1);
        assert.equal(deselectEventCounters[1], 1);
        assert.equal(selectEventCounters[2], 1);
        assert.equal(deselectEventCounters[2], 1);
      });

      test('toggle cells-selected class when toggling items selection', async () => {
        // setup listener for cells-item-select/deselect events
        var item0 = s.children[0], item1 = s.children[1];

        assert.isFalse(item0.classList.contains('cells-selected'));
        assert.isFalse(item1.classList.contains('cells-selected'));

        // click to select item 0 (add cells-selected class)
        MockInteractions.click(item0);
        await s.updateComplete;

        assert.isTrue(item0.classList.contains('cells-selected'));
        assert.isFalse(item1.classList.contains('cells-selected'));

        // click to select item 1 (add cells-selected class)
        MockInteractions.click(item1);
        await s.updateComplete;

        assert.isTrue(item0.classList.contains('cells-selected'));
        assert.isTrue(item1.classList.contains('cells-selected'));

        // click to deselect item 1 (remove cells-selected class)
        MockInteractions.click(item1);
        await s.updateComplete;

        assert.isTrue(item0.classList.contains('cells-selected'));
        assert.isFalse(item1.classList.contains('cells-selected'));

        // programatically select both values (1 add cells-selected class)
        s.selectedValues = [0, 1];
        await s.updateComplete;

        assert.isTrue(item0.classList.contains('cells-selected'));
        assert.isTrue(item1.classList.contains('cells-selected'));

        // programatically deselect all values (both removes cells-selected class)
        s.selectedValues = [];
        await s.updateComplete;

        assert.isFalse(item0.classList.contains('cells-selected'));
        assert.isFalse(item1.classList.contains('cells-selected'));
      });

      test('fires selected-values-changed when selection changes', () => {
        var selectedValuesChangedEventCounter = 0;

        s.addEventListener('selected-values-changed', (e) => {
          selectedValuesChangedEventCounter++;
        });

        MockInteractions.click(s.children[0]);
        MockInteractions.click(s.children[0]);
        MockInteractions.click(s.children[0]);

        expect(selectedValuesChangedEventCounter);
      });

      test('updates selection when dom changes', async () => {
        var firstChild = s.querySelector(':first-child');
        var lastChild = s.querySelector(':last-child');

        MockInteractions.click(firstChild);
        MockInteractions.click(lastChild);

        expect(s.selectedItems.length).to.be.equal(2);

        s.removeChild(lastChild);

        await s.updateComplete;
        // See the note in `forceSynchronousItemUpdate`.
        s.forceSynchronousItemUpdate();

        expect(s.selectedItems.length).to.be.equal(1);
        expect(s.selectedItems[0]).to.be.equal(firstChild);
      });

      suite('`select()` and `selectIndex()`', () => {
        var selector;

        setup(async () => {
          selector = fixture('valueById');
          return await selector.updateComplete;
        });

        test('`select()` selects an item with the given value', async () => {
          selector.select('item1');
          await selector.updateComplete;
          assert.equal(selector.selectedValues.length, 1);
          assert.equal(selector.selectedValues.indexOf('item1'), 0);

          selector.select('item3');
          await selector.updateComplete;
          assert.equal(selector.selectedValues.length, 2);
          assert.isTrue(selector.selectedValues.indexOf('item3') >= 0);

          selector.select('item2');
          await selector.updateComplete;
          assert.equal(selector.selectedValues.length, 3);
          assert.isTrue(selector.selectedValues.indexOf('item2') >= 0);
        });

        test('`selectIndex()` selects an item with the given index', async () => {
          selector.selectIndex(1);
          await selector.updateComplete;
          assert.equal(selector.selectedValues.length, 1);
          assert.isTrue(selector.selectedValues.indexOf('item1') >= 0);
          assert.equal(selector.selectedItems.length, 1);
          assert.isTrue(selector.selectedItems.indexOf(selector.items[1]) >= 0);

          selector.selectIndex(3);
          await selector.updateComplete;
          assert.equal(selector.selectedValues.length, 2);
          assert.isTrue(selector.selectedValues.indexOf('item3') >= 0);
          assert.equal(selector.selectedItems.length, 2);
          assert.isTrue(selector.selectedItems.indexOf(selector.items[3]) >= 0);

          selector.selectIndex(0);
          await selector.updateComplete;
          assert.equal(selector.selectedValues.length, 3);
          assert.isTrue(selector.selectedValues.indexOf('item0') >= 0);
          assert.equal(selector.selectedItems.length, 3);
          assert.isTrue(selector.selectedItems.indexOf(selector.items[0]) >= 0);
        });
      });

      // test('toggle multi from true to false', () => {
      //   // set selected
      //   s.selected = [0, 2];
      //   var first = s.selected[0];
      //   // set mutli to false, so to make it single-selection
      //   s.multi = false;
      //   // selected should not be an array
      //   assert.isNotArray(s.selected);
      //   // selected should be the first value from the old array
      //   assert.equal(s.selected, first);
      // });
    });
  </script>

</body>
</html>
