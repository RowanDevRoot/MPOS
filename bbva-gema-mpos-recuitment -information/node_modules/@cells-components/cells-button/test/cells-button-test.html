<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>cells-button test</title>
  <script src="../node_modules/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
  <script src="../node_modules/mocha/mocha.js"></script>
  <script src="../node_modules/wct-mocha/wct-mocha.js"></script>
  <script src="../node_modules/chai/chai.js"></script>
  <script src="../node_modules/sinon/pkg/sinon.js"></script>
  <script src="../node_modules/@polymer/test-fixture/test-fixture.js"></script>
  <script src="../node_modules/sinon-chai/lib/sinon-chai.js"></script>
</head>

<body>

  <form id="form1" onsubmit="return false;">
    <test-fixture id="default">
      <template>
        <cells-button></cells-button>
      </template>
    </test-fixture>
  </form>

  <test-fixture id="role">
    <template>
      <cells-button role="toggle"></cells-button>
    </template>
  </test-fixture>

  <test-fixture id="disabled">
    <template>
      <cells-button disabled></cells-button>
    </template>
  </test-fixture>

  <test-fixture id="autofocus">
    <template>
      <cells-button autofocus></cells-button>
    </template>
  </test-fixture>

  <form id="form2" onsubmit="return false;">
    <test-fixture id="custom-no-form">
      <template>
        <custom-button></custom-button>
      </template>
    </test-fixture>
  </form>

  <script type="module">
    import { CellsButton, html } from './test.js';

    suite('cells-button', () => {
      let el;
      let form1 = document.querySelector('#form1');
      let form2 = document.querySelector('#form2');

      suite('default', () => {
        setup(async () => {
          el = fixture('default');
          await el.updateComplete;
        });

        test('element without autofocus gets no focus on init', () => {
          assert.notEqual(document.activeElement, el);
        });

        test('disabling button updates aria-disabled and tabindex', async () => {
          assert.equal(el.getAttribute('aria-disabled'), 'false');
          assert.equal(el.getAttribute('tabindex'), '0');
          el.disabled = true;
          await el.updateComplete;
          assert.equal(el.getAttribute('aria-disabled'), 'true');
          assert.equal(el.getAttribute('tabindex'), '-1');
        });

        test('button has role button', () => {
          assert.equal(el.getAttribute('role'), 'button');
        });

        test('button has tabindex according to disabled attribute', () => {
          assert.equal(el.getAttribute('tabindex'), '0');
        });

        test('click dispatches event to native button', () => {
          const nativeButton = el.querySelector('button');
          const spy = sinon.spy();
          nativeButton.addEventListener('click', spy);
          sinon.assert.notCalled(spy);
          el.click();
          sinon.assert.calledOnce(spy);
        });

        test('keyup with enter key on active button fires click', () => {
          el.active = true;
          const spy = sinon.spy();
          el.addEventListener('click', spy);
          sinon.assert.notCalled(spy);
          const event = new KeyboardEvent('keyup', {
            keyCode: 13
          });
          el.dispatchEvent(event);
          sinon.assert.calledOnce(spy);
        });

        test('keyup with spacebar key on active button fires click', () => {
          el.active = true;
          const spy = sinon.spy();
          el.addEventListener('click', spy);
          sinon.assert.notCalled(spy);
          const event = new KeyboardEvent('keyup', {
            keyCode: 32
          });
          el.dispatchEvent(event);
          sinon.assert.calledOnce(spy);
        });

        test('keyup with other key on active button does not fire click', () => {
          el.active = true;
          const spy = sinon.spy();
          el.addEventListener('click', spy);
          sinon.assert.notCalled(spy);
          const event = new KeyboardEvent('keyup', {
            keyCode: 48
          });
          el.dispatchEvent(event);
          sinon.assert.notCalled(spy);
        });

        test('keyup on non-active button does not fire click', () => {
          const spy = sinon.spy();
          el.addEventListener('click', spy);
          sinon.assert.notCalled(spy);
          const event = new KeyboardEvent('keyup', {
            keyCode: 13
          });
          el.dispatchEvent(event);
          sinon.assert.notCalled(spy);
        });
      });

      suite('disabled', () => {
        setup(async () => {
          el = fixture('disabled');
          await el.updateComplete;
        });

        test('enabling button updates aria-disabled and tabindex', async () => {
          assert.equal(el.getAttribute('aria-disabled'), 'true');
          assert.equal(el.getAttribute('tabindex'), '-1');
          el.disabled = false;
          await el.updateComplete;
          assert.equal(el.getAttribute('aria-disabled'), 'false');
          assert.equal(el.getAttribute('tabindex'), '0');
        });

        test('button has tabindex according to disabled attribute', () => {
          assert.equal(el.getAttribute('tabindex'), '-1');
        });

        test('click with disabled prevents other listeners from being called', () => {
          const spy = sinon.spy();
          el.addEventListener('click', spy);
          sinon.assert.notCalled(spy);
          el.click();
          sinon.assert.notCalled(spy);
        });
      });

      suite('role', () => {
        setup(async () => {
          el = fixture('role');
          await el.updateComplete;
        });

        test('role button does not override user-defined role', () => {
          assert.equal(el.getAttribute('role'), 'toggle');
        });
      });

      suite('autofocus', () => {
        setup(async () => {
          el = fixture('autofocus');
          await el.updateComplete;
        });

        test('autofocus attribute sets focus to element on init', () => {
          assert.equal(document.activeElement, el);
        });
      });

      suite('native form', () => {
        setup(async () => {
          el = fixture('default');
          await el.updateComplete;
        });

        test('form attributes are propagated to inner button', async () => {
          const nativeButton = el.querySelector('button');
          assert.isFalse(nativeButton.hasAttribute('form'));
          assert.isFalse(nativeButton.hasAttribute('formaction'));
          assert.isFalse(nativeButton.hasAttribute('formenctype'));
          assert.isFalse(nativeButton.hasAttribute('formmethod'));
          assert.isFalse(nativeButton.hasAttribute('formnovalidate'));
          assert.isFalse(nativeButton.hasAttribute('formtarget'));
          el.form = 'form2';
          el.formAction = 'customAction';
          el.formEnctype = 'enctype';
          el.formMethod = 'post';
          el.formNoValidate = true;
          el.formTarget = '_blank';
          await el.updateComplete;
          assert.equal(nativeButton.getAttribute('form'), 'form2');
          assert.equal(nativeButton.getAttribute('formaction'), 'customAction');
          assert.equal(nativeButton.getAttribute('formenctype'), 'enctype');
          assert.equal(nativeButton.getAttribute('formmethod'), 'post');
          assert.isTrue(nativeButton.hasAttribute('formnovalidate'));
          assert.equal(nativeButton.getAttribute('formtarget'), '_blank');
        });

        test('click submits form', () => {
          const spy = sinon.spy();
          form1.addEventListener('submit', e => {
            e.preventDefault();
            spy();
          });
          sinon.assert.notCalled(spy);
          el.click();
          sinon.assert.calledOnce(spy);
        });
      });

      suite('active state', () => {
        setup(async () => {
          el = fixture('default');
          await el.updateComplete;
        });

        test('keydown with enter key sets active to true', () => {
          assert.isFalse(el.active);
          const event = new KeyboardEvent('keydown', {
            keyCode: 13
          });
          el.dispatchEvent(event);
          assert.isTrue(el.active);
        });

        test('keydown with spacebar key sets active to true', () => {
          assert.isFalse(el.active);
          const event = new KeyboardEvent('keydown', {
            keyCode: 32
          });
          el.dispatchEvent(event);
          assert.isTrue(el.active);
        });

        test('mousedown sets active to true', () => {
          assert.isFalse(el.active);
          const event = new MouseEvent('mousedown');
          el.dispatchEvent(event);
          assert.isTrue(el.active);
        });

        test('keydown with other key does not set active', () => {
          assert.isFalse(el.active);
          const event = new KeyboardEvent('keydown', {
            keyCode: 48
          });
          el.dispatchEvent(event);
          assert.isFalse(el.active);
        });

        test('keyup with enter key on active button sets active to false', () => {
          el.active = true;
          const event = new KeyboardEvent('keyup', {
            keyCode: 13
          });
          el.dispatchEvent(event);
          assert.isFalse(el.active);
        });

        test('mouseup on active button after previous mousedown sets active to false', () => {
          const eventDown = new MouseEvent('mousedown');
          el.dispatchEvent(eventDown);
          assert.isTrue(el.active);
          const eventUp = new MouseEvent('mouseup', {bubbles: true, composed: true});
          el.dispatchEvent(eventUp);
          assert.isFalse(el.active);
        });

        test('keyup with spacebar key on active button sets active to false', () => {
          el.active = true;
          const event = new KeyboardEvent('keyup', {
            keyCode: 32
          });
          el.dispatchEvent(event);
          assert.isFalse(el.active);
        });

        test('keyup with other key on active button does not set active to false', () => {
          el.active = true;
          const event = new KeyboardEvent('keyup', {
            keyCode: 48
          });
          el.dispatchEvent(event);
          assert.isTrue(el.active);
        });

        test('blur on element sets active to false', () => {
          el.active = true;
          const event = new FocusEvent('blur');
          el.dispatchEvent(event);
          assert.isFalse(el.active);
        });

        test('disconnecting element sets active to false', () => {
          el.active = true;
          el.remove();
          assert.isFalse(el.active);
        });
      });

      suite('custom without native', () => {
        class CustomButton extends CellsButton {
          render() {
            return html`
              <slot></slot>
            `;
          }
        }
        customElements.define('custom-button', CustomButton);

        setup(async () => {
          el = fixture('custom-no-form');
          await el.updateComplete;
        });

        test('not using _button in extending button does not generate native button', async () => {
          const nativeButton = el.querySelector('button');
          assert.isNull(nativeButton);
        });

        test('click without inner _button does not submit form', async () => {
          const spy = sinon.spy();
          form2.addEventListener('submit', e => {
            e.preventDefault();
            spy();
          });
          sinon.assert.notCalled(spy);
          el.click();
          sinon.assert.notCalled(spy);
        });
      });
    });
  </script>

</body>

</html>
